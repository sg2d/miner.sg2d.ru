"use strict";const allHashes=2**32,maxWorkers=32,workers=[],nonceSets=[];let clustersDimmPow=null,clustersDimm=null,qClusters=null;const randomClusters=[];let lastCluster=0,qNoncesInCluster=0,tmrCheckWorkers=null,eTBodyWorkers,eTHInputHashesPerSecond,eTHInputHashesCore,eTestValue,eTBodyFillStats,eInputRemainedTime;const exampleResponse='{"result":{"midstate":"fd8c924ed9a07c7d6dd49c1079429142d94cf99d6bb978e123190d52fbf8ef6f","data":"0000000116237c0c0d1baffc50d4bf2a19bf5bc6fbf381c26bac4a0a0000db40000000008108b0619305607e7f04634ffe7ef35294970d5656694c6b7a0ef3b07b87e9ac4d8d90321b00f33900000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000080020000","hash1":"00000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000010000","target":"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000"},"error":null,"id":0}';function inputClustersDimmPow(e){var t=2**parseInt(document.querySelector("#list_clusters_dimm_pow").value);document.querySelector("#list_clusters_text").innerHTML=getClusterCurrentValue(t)}function getClusterCurrentValue(e){var t=e*e;return e+"x"+e+"="+e*e+" (&#8776;"+Math.round(allHashes/t)+" nonces/cluster)"}function changeClustersDimmPow(){const m=document.querySelector("#list_clusters_dimm_pow");m.setAttribute("disabled","disabled"),setTimeout(()=>{clustersDimmPow=parseInt(document.querySelector("#list_clusters_dimm_pow").value),clustersDimm=2**clustersDimmPow,qClusters=clustersDimm*clustersDimm,document.querySelector("#list_clusters_text").innerHTML=getClusterCurrentValue(clustersDimm),qNoncesInCluster=2**(32-2*clustersDimmPow),nonceSets.length=0;var t=Math.round(.1*qClusters);let r=0;for(let e=0;e<qClusters;e++){var s=Math.max(t,Math.floor(2*(qNoncesInCluster-t)*Math.random())),o={index:e+1,start:r,count:s-1,takenRandom:!1};nonceSets.push(o),r=safe_add(r,s)}nonceSets[nonceSets.length-1].count=-1-nonceSets[nonceSets.length-1].start;var e=document.querySelector("#fill_statistics");(eTBodyFillStats=e.getElementsByTagName("tbody")[0]).innerHTML="";let n=0;for(let t=0;t<clustersDimm;t++){var a=eTBodyFillStats.insertRow();for(let e=0;e<clustersDimm;e++){var l=a.insertCell(),u=(l.innerHTML="&nbsp;",nonceSets[n]);u.x=e+1,u.y=t+1,u.eTD=l,n++}}let d=0;var i=nonceSets.length;for(let e=0;e<i;e++)nonceSets[e].takenRandom=!1;e:for(let e=0;e<i;e++)for(;;){if(++d>2**20){console.error("Не удалось полностью сгенерировать матрицу случайного перебора кластеров nonces! i="+e+", b="+d);break e}var c=Math.floor(i*Math.random());if(!nonceSets[c].takenRandom){c=nonceSets[c];c.eTD,(randomClusters[e]=c).takenRandom=!0,c.eTD.style.backgroundColor="#ddd";break}}m.removeAttribute("disabled")},0)}function changeWorkers(){const e=document.querySelector("#list_workers");e.setAttribute("disabled","disabled"),setTimeout(()=>{var t=parseInt(document.querySelector("#list_workers").value);document.querySelector("#workers_text").innerText=t;for(let e=eTBodyWorkers.rows.length-1;0<=e;e--)eTBodyWorkers.removeChild(eTBodyWorkers.rows[e]);for(let e=0;e<workers.length;e++)workers[e].workerThread&&workers[e].workerThread.terminate();for(let e=workers.length=0;e<t;e++){var r=eTBodyWorkers.insertRow(),s=(r.insertCell().innerText=e+1,r.insertCell()),o=(s.innerText="wait...",r.insertCell()),n=(o.innerHTML='<INPUT class="num" readonly/>',r.insertCell()),r=(n.innerHTML='<INPUT class="num" readonly/>',r.insertCell());r.innerHTML='<INPUT class="num" readonly/>',workers.push({hashes:0,hashes_per_second:0,hashes_core:0,eCellCluster:s,eInputHashes:o.firstElementChild,eInputHashesPerSecond:n.firstElementChild,eInputHashesCore:r.firstElementChild,workerThread:null})}e.removeAttribute("disabled")},100)}document.addEventListener("DOMContentLoaded",()=>{eTestValue=document.querySelector("#test_value");var e=JSON.parse(exampleResponse).result,e=(document.querySelector("#resp_midstate").value=e.midstate,document.querySelector("#resp_data").value=e.data,document.querySelector("#resp_hash1").value=e.hash1,document.querySelector("#resp_target").value=e.target,document.querySelector("#workers_statistics")),t=(eTHInputHashesPerSecond=e.querySelector("#hashes_per_second"),eTHInputHashesCore=e.querySelector("#hashes_core"),eTBodyWorkers=e.getElementsByTagName("tbody")[0],document.querySelector("#rangeWorkers"));for(let e=0;e<maxWorkers;e++){var r=document.createElement("option");r.value=e,r.innerHTML=e,t.appendChild(r)}document.querySelector("#list_workers").setAttribute("max",maxWorkers),eInputRemainedTime=document.querySelector("#remained_time"),changeClustersDimmPow(),changeWorkers()});let stime;function startMining(){document.querySelector("#start_mining").setAttribute("disabled","disabled"),document.querySelector("#list_workers").setAttribute("disabled","disabled"),document.querySelector("#list_clusters_dimm_pow").setAttribute("disabled","disabled"),document.querySelector("#stop_mining").removeAttribute("disabled"),document.querySelector("#golden_ticket").classList.remove("finded"),document.querySelector("#golden_ticket").value="calc...",workersTerminate();for(let e=0;e<workers.length;e++){var t=workers[e];t.workerThread=new Worker("miner.js"),t.workerThread.onmessage=onWorkerMessage,t.workerThread.onerror=onWorkerError,t.status=0,t.hashes_core=0,t.hashes_per_second=null}stime=(new Date).getTime(),checkWorkers(),tmrCheckWorkers=setInterval(checkWorkers,1e3)}function getRemainedTimeText(e){var t=Math.floor(e/31104e6),r=Math.floor(e/2592e6%12),s=Math.floor(e/864e5%30),o=Math.floor(e/36e5%24),n=Math.floor(e/6e4%60),e=Math.floor(e/1e3%60);return"-"+(0<t?t+"y ":"")+(0<r?r+"m ":"")+(0<s?s+"d ":"")+(o<10?"0":"")+o+":"+(n<10?"0":"")+n+":"+(e<10?"0":"")+e}function checkWorkers(){let t=0,r=0;for(let e=workers.length-1;0<=e;e--){var s=workers[e];t+=s.hashes_per_second,r+=s.hashes_core}eTHInputHashesPerSecond.value=Math.round(t);var e=r/allHashes,o=(new Date).getTime()-stime,o=(eTHInputHashesCore.value=(Math.round(1e4*e)/100).toFixed(2)+"%",Math.round(o/e));if(eInputRemainedTime.value=isFinite(o)?getRemainedTimeText(o):"wait...",lastCluster<nonceSets.length)for(let e=0;e<workers.length;e++)if(0===workers[e].status){if(++lastCluster>nonceSets.length)break;var n,a,l=randomClusters[lastCluster-1];l.takenRandom&&(n=workers[e],(a=getJob(e+1,l.index,l.start,l.count)).start_date=(new Date).getTime(),n.status=1,n.workerThread.postMessage({job:a}),l.eTD.style.backgroundColor="#ff0",l.eTD.style.borderColor="#ffa",n.eCellCluster.innerText=l.index+"/"+l.count)}}function stopMining(){clearInterval(tmrCheckWorkers),tmrCheckWorkers=null,workersTerminate(),document.querySelector("#stop_mining").setAttribute("disabled","disabled"),document.querySelector("#list_workers").removeAttribute("disabled"),document.querySelector("#list_clusters_dimm_pow").removeAttribute("disabled"),document.querySelector("#start_mining").removeAttribute("disabled")}function workersTerminate(){for(let e=0;e<workers.length;e++)workers[e].workerThread&&(workers[e].workerThread.terminate(),workers[e].workerThread=null)}let index=0;function onWorkerMessage(e){var t,e=e.data,r=(index=e.uid-1,workers[index]);r.status=e.status,r&&(t=(new Date).getTime()-e.start_date,t=Math.round(1e3*e.hashes/t),isFinite(t)&&0!==t&&(r.hashes_per_second=t,r.eInputHashesPerSecond.value=r.hashes_per_second),r.eInputHashes.value=e.hashes),0===e.status&&(t=nonceSets[e.cluster_index-1],!1!==e.golden_ticket?(document.querySelector("#golden_ticket").classList.add("finded"),document.querySelector("#golden_ticket").value=e.golden_ticket,stopMining(),t.eTD.style.backgroundColor="#f00",t.eTD.style.borderColor="#ff0"):(t.eTD.style.backgroundColor="#0f0",t.eTD.style.borderColor="#aaa"),r.hashes_core+=t.count,r.eInputHashesCore.value=r.hashes_core)}function onWorkerError(e){throw e.data}function getJob(e,t,r,s){var o=JSON.parse(exampleResponse).result,e=(document.querySelector("#resp_midstate").value=o.midstate,document.querySelector("#resp_data").value=o.data,document.querySelector("#resp_hash1").value=o.hash1,document.querySelector("#resp_target").value=o.target,{uid:e,cluster_index:t,nonce_start:r,nonce_count:s,midstate:hexstringToBinary(o.midstate),data:hexstringToBinary(o.data),hash1:hexstringToBinary(o.hash1),target:hexstringToBinary(o.target)});return e.data=e.data.slice(16),e}function hexstringToBinary(e){for(var t=new Array,r=0;r<e.length;r+=8){for(var s=0,o=0;o<4;++o)s=safe_add(s,hexToByte(e.substring(r+2*o,r+2*o+2))<<8*o);t.push(s)}return t}function hexToByte(e){return parseInt(e,16)}function test(){let e=0,t=2147483645,r=t,s=(console.log(t+"/"+r),setInterval(()=>{t=safe_add(t,1048576),r+=1048576,console.log(t+"/"+r),eTestValue.innerText=t+"/"+r,10<++e&&clearInterval(s)},0))}